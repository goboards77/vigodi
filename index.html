<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Vigodi</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <script src="https://unpkg.com/tabulator-tables@5.5.0/dist/js/tabulator.min.js"></script>    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono&display=swap" rel="stylesheet">
    <link href="https://unpkg.com/tabulator-tables@5.5.0/dist/css/tabulator.min.css" rel="stylesheet">
</head>
<body id="body" class="bg-gray-100" style="font-family: 'Roboto'; font-size: 18px;">
    <div id="MC" class="hidden w-full max-w-md p-2 m-3 rounded-xl border border-pink-500">
        <h2 id="H1" class="hidden mb-3 mt-3">🤝 Welcome to Vigodi 💐</h2>
        <button id="M1" class="hidden btnM" onclick="showEle('MC','A','B','C','D','E','F','G','H','I','J','bBtn','sBtn')">✍🏻 Add Name</button>
        <button id="M2" class="hidden btnM" onclick="showEle('MC','B','C','D','E','F','bBtn','srBtn')">👨‍👩‍👦‍👦 Ancestors</button>
        <button id="M3" class="hidden btnM" onclick="viewAllData(true,true)">👀 All Data</button>
        <button id="M4" class="hidden btnM" onclick="showEle('MC','bBtn'); sankhya();">👀 Sankhya</button>
        <button id="M5" class="hidden btnM" onclick="topStats()">🏅 Rankings</button>
        <button id="M6" class="hidden btnM" onclick="logout()">🔐 Logout</button>

        <button id="bBtn" class="hidden Sbtn bg-lime-500" onclick="showEle('MC','H1','M1','M2','M3','M4','M5','M6')">🏠︎</button>
        <button id="sBtn" class="hidden Sbtn bg-green-500" onclick="saveTran()">💾 Add New Name & details</button>
        <button id="srBtn" class="hidden Sbtn bg-pink-500" onclick="searchAnc();">🔍 Search Ancestors</button>  

        <div id="A" class="hidden relative mt-4"><input id="Nokh" class="inp"><label class="lbl">Nokh</label></div>
        <div id="B" class="hidden relative mt-4"><input id="Name" class="inp"><label class="lbl">Name</label></div>
        <div id="C" class="hidden relative mt-4"><input id="Father" class="inp"><label class="lbl">Father</label></div>
        <div id="D" class="hidden relative mt-4"><input id="Mother" class="inp"><label class="lbl">Mother</label></div>
        <div id="E" class="hidden relative mt-4"><input id="Gfather" class="inp"><label class="lbl">Gfather</label></div>
        <div id="F" class="hidden relative mt-4"><input id="Gmother" class="inp"><label class="lbl">Gmother</label></div>
        <div id="G" class="hidden relative mt-4"><input id="Mstatus" class="inp"><label class="lbl">Mstatus</label></div>
        <div id="H" class="hidden relative mt-4"><input id="Njmf" class="inp"><label class="lbl">Njmf</label></div>
        <div id="I" class="hidden relative mt-4"><input id="Place" class="inp"><label class="lbl">Place</label></div>
        <div id="J" class="hidden relative mt-4"><input id="Mobno" class="inp mb-10"><label class="lbl">Mobno</label></div>
    </div>
    
    <div id="AC" class="hidden m-3 w-full max-w-md bg-white rounded-lg shadow-[0_8px_15px_rgba(0,0,0,0.4)]"></div>

    <input id="sBox" class="hidden w-full max-w-md px-2 m-3 h-10 rounded shadow-[0_8px_15px_rgba(0,0,0,0.8)]" placeholder="Search..." type="text" autocomplete="off"/>
    <button id="bkkbtn" class="hidden Sbtn inline-block bg-purple-500" onclick="clearInput(); showEle('MC','H1','M1','M2','M3','M4','M5','M6')">🏠︎</button>
    <button id="exlbtn" class="hidden Sbtn inline-block bg-green-500">XL</button>
    <button id="pdfbtn" class="hidden Sbtn inline-block bg-pink-500">PDF</button>
    <div id="table" class="hidden w-full ml-3 rounded-b-lg border border-green-600 mx-auto text-[18px] font-[Roboto]"></div>
    
    <div id="X" class="hidden relative mt-6"><input id="loginEmail" class="peer w-full max-w-md px-1 pt-1 border-b-2 border-gray-500 outline-none bg-transparent" type="email"><label class="lbl">Email</label></div>
    <div id="Y" class="hidden relative mt-6"><input id="loginPassword" class="peer w-full max-w-md px-1 pt-1 border-b-2 border-gray-500 outline-none bg-transparent" type="password"><label class="lbl">Password</label></div>
    <button id="Z" class="hidden Sbtn mt-5 mb-5 bg-purple-500" onclick="login()">🏠︎ Login</button>
    
<script type="module">
    import {initializeApp} 
    from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import {getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut,} 
    from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import {getFirestore, collection, doc, getDocs, getDoc, addDoc, updateDoc, deleteDoc, query, where, deleteField  } 
    from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
    const firebaseConfig = {
        apiKey: "AIzaSyDFYd3RFA0oaJ2A74cLdIm_raus_QHivX8",
        authDomain: "vigodi-64ecd.firebaseapp.com",
        projectId: "vigodi-64ecd",
        storageBucket: "vigodi-64ecd.firebasestorage.app",
        messagingSenderId: "151383854150",
        appId: "1:151383854150:web:ce0bb6c90844203e6f0e47",
        measurementId: "G-4VKY4HEYCG"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    let cachedData = [], currentDocId = null, allRows = [];
    onAuthStateChanged(auth, async (user) => {
        if (user) {
            window.isAdmin = user.email === "goboards77@gmail.com";
            window.tranCol = collection(db, (await getDoc(doc(db, "users", user.uid))).data().db);
            
            await fetchAllOnce(); 
            await loadDropdownData(); 
            showEle('MC','H1','M1','M2','M3','M4','M5','M6');
            
        } else (showEle('X','Y','Z'))
    });

    function applyClasses(selector, classes, attrs = {}) {
        document.querySelectorAll(selector).forEach(el => {
            if (classes) {el.classList.add(...classes.split(" "));}
            for (const [key, value] of Object.entries(attrs)) {el.setAttribute(key, value);}
        });
    }
    applyClasses(".btnM", "block w-full max-w-md py-3 text-left rounded hover:bg-blue-600 hover:text-white");
    applyClasses(".Sbtn", "inline-block px-5 h-10 mb-2 font-bold rounded shadow-[0_8px_15px_rgba(0,0,0,0.8)] duration-500 hover:scale-110");
    applyClasses(".inp", "peer w-full max-w-md px-1 pt-1 border-b-2 border-gray-500 outline-none bg-transparent" , { type: "text", autocomplete: "off", placeholder: " " });
    applyClasses(".lbl", "absolute top-2 left-0 text-gray-600 transform -translate-y-6 scale-[.8] peer-placeholder-shown:translate-y-0 peer-placeholder-shown:scale-[1] peer-focus:-translate-y-6 peer-focus:scale-[.8]");

    window.fetchAllOnce = async function () {
        if (cachedData.length > 0) { return cachedData; }
        const snapshot = await getDocs(tranCol);
        cachedData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); 
        return cachedData;
    };

    window.showEle = function (...ids) { 
        clearInput();
        document.querySelectorAll("#MC > *, #ancCont > *").forEach(el => {el.classList.add("hidden"); });
        Array.from(body.children).forEach(el => {el.classList.add("hidden");}); 
        ids.forEach(id => document.getElementById(id).classList.remove("hidden")); 
    };

    window.attachDropdown = function (input, items) {
        let wrapper = input.parentElement, currentList = [], highlightedIndex = -1;
        if (!wrapper.classList.contains("relative")) {
            wrapper = document.createElement("div");
            wrapper.className = "relative w-full";
            input.parentNode.insertBefore(wrapper, input);
            wrapper.appendChild(input);
        }

        let list = document.createElement('div');
        list.id = "myList";
        list.className = 'absolute z-10 w-full max-w-md bg-gray-200 rounded-b-lg max-h-60 overflow-y-auto hidden border border-gray-500';
        wrapper.appendChild(list);

        let filtered = items.slice();
        let index = -1;
        let open = false;

        function render() {
            list.innerHTML = '';
            if (open && (input.value.trim() !== '' || filtered.length > 0)) {list.classList.remove('hidden');} 
            else {list.classList.add('hidden');}
            filtered.forEach((item, i) => {
                const div = document.createElement('div');
                div.textContent = item;
                div.className = 'px-2 py-1 cursor-pointer hover:bg-blue-700 hover:text-white border-b border-gray-500 last:border-b-0';
                if (i === index) div.classList.add('bg-blue-500', 'text-white');
                div.addEventListener('mousedown', e => e.preventDefault());
                div.addEventListener('click', () => select(item));
                list.appendChild(div);
            });
        }

        function select(value) {
            input.value = value;
            list.classList.add('hidden');
            const allInputs = Array.from(document.querySelectorAll('#menuCont input:not([type="hidden"])'));
            const currentIndex = allInputs.indexOf(input);
            if (currentIndex !== -1 && allInputs[currentIndex + 1]) { allInputs[currentIndex + 1].focus(); }
        }

        input.addEventListener('focus', () => { open = true; render(); });
        input.addEventListener('blur', () => { setTimeout(() => { open = false; render(); }, 150); });
        input.addEventListener('input', () => {
            const q = input.value.toLowerCase();
            filtered = items.filter(i => i.toLowerCase().includes(q));
            index = -1;
            render();
        });
        input.addEventListener('keydown', e => {
            if (e.key === 'ArrowDown') { e.preventDefault(); index = Math.min(index + 1, filtered.length - 1); render(); }
            else if (e.key === 'ArrowUp') { e.preventDefault(); index = Math.max(index - 1, 0); render(); }
            else if (e.key === 'Enter') { 
                e.preventDefault(); 
                if (index >= 0) select(filtered[index]); 
                const formElements = Array.from(document.querySelectorAll("input, textarea, select"));
                const currentIndex = formElements.indexOf(e.target);
                if (currentIndex >= 0 && currentIndex < formElements.length - 1) {formElements[currentIndex + 1].focus();}
            }
            else if (e.key === "Escape") {list.classList.add('hidden');}
        });
    }

    window.loadDropdownData = async function () {
        const nokhSet = new Set();
        const nameSet = new Set();
        const placeSet = new Set();
        cachedData.forEach(d => {
            if (d.Nokh?.trim()) nokhSet.add(d.Nokh.trim());
            nameSet.add(d.Name || d.Father || d.Mother || d.Gfather || d.Gmother);
            if (d.Place?.trim()) placeSet.add(d.Place.trim());
        });
        const dropdownData = {
            'Nokh': [...nokhSet].sort(),
            'Name': [...nameSet].sort(),
            'Father': [...nameSet].sort(),
            'Mother': [...nameSet].sort(),
            'Gfather': [...nameSet].sort(),
            'Gmother': [...nameSet].sort(),
            'Mstatus': ['Married', 'Unmarried', 'Vidhur', 'Gaswa', 'Swargiya'],
            'Njmf': ["Niyani", "Jamai", "Male", "Female"],
            'Place': [...placeSet].sort(),
            'Mobno': [],
        };

        Object.keys(dropdownData).forEach(id => {
            const input = document.getElementById(id);
            if (input) {attachDropdown(input, dropdownData[id]);}
            if (input.type === "text") {
            input.addEventListener('input', function () {
                const start = this.selectionStart;
                const end = this.selectionEnd;
                this.value = this.value.toLowerCase().replace(/\b\w/g, char => char.toUpperCase());
                this.setSelectionRange(start, end);
            });
        }
        });
    };

    window.createEditableTable = function (rows, columns, showDelete = true, showUpdate = true) {
        if (window.table && typeof window.table.destroy === "function") window.table.destroy();
        const searchId = document.getElementById('sBox');
        let fullColumns = columns.map(col => { return { ...col, editor: false };});

        if (isAdmin && showDelete) {
            fullColumns.push({
                title: "",
                field: "__delete",
                formatter: () => `<div class="text-center cursor-pointer">⛔</div>`,
                width: 70,
                hozAlign: "center",
                cellClick: async (e, cell) => {
                    e.stopPropagation();
                    const rowData = cell.getRow().getData();
                    const confirmed = confirm("Delete? Are You Sure?");
                    if (confirmed && rowData.id) {
                        await deleteDoc(doc(tranCol, rowData.id));
                        cell.getRow().delete();
                        if (cachedData) cachedData = cachedData.filter(doc => doc.id !== rowData.id);
                    }
                },
            });
        }

        if (isAdmin && showUpdate) {
            fullColumns.push({
                title: "",
                field: "__update",
                formatter: () => `<div class="text-center cursor-pointer">✏️</div>`,
                width: 70,
                hozAlign: "center",
                cellClick: (e, cell) => {
                    e.stopPropagation();
                    const rowData = cell.getRow().getData();
                    currentDocId = rowData.id;
                    showTransactionContainer(rowData);
                },
            });
        }

        window.table = new Tabulator(document.getElementById('table'), {
            data: rows,
            layout: "fitDataFill",
            reactiveData: true,
            rowHeight: 40,
            maxHeight: "675px",
            headerVisible: true,
            columns: fullColumns
        });

        table.on("headerDblClick", function (e, column) { let field = column.getField(); table.deleteColumn(field); });
        document.getElementById('exlbtn')?.addEventListener("click", () => { window.table.download("xlsx", "data.xlsx", { sheetName: "Sheet1" }); });
        document.getElementById('pdfbtn')?.addEventListener("click", () => { window.table.download("pdf", "data.pdf", { orientation: "portrait" }); });
        bindSearch();
        showEle('sBox', 'bkkbtn', 'exlbtn', 'pdfbtn', 'table');
    };

    window.bindSearch = function () {
        document.getElementById("sBox").addEventListener("input", function () {
            const value = this.value.toLowerCase().trim();
            table.setFilter(function (data) {
                if (value === "") { return true; }
                return Object.values(data).some(val => String(val).toLowerCase().includes(value)); 
            }); 
        }); 
    };
   
    window.showTransactionContainer = function (rowData) {
        clearInput();
        showEle('A','B','C','D','E','F','G','H','I','J')
        for (const key in rowData) {
            if (rowData.hasOwnProperty(key)) {
                const input = document.getElementById(key); 
                if (input) {input.value = rowData[key] || "";} 
            } 
        }
    };

    window.saveTran = async function () {
        const fields = ['Nokh','Name','Father','Mother','Gfather','Gmother','Mstatus','Njmf','Place','Mobno'];    
        const values = {};
        fields.forEach(id => { const el = document.getElementById(id); values[id] = el ? el.value.trim() : ""; });
        
        if (!values.Nokh || !values.Name || !values.Father || !values.Mother || !values.Gfather || !values.Gmother || !values.Mstatus || !values.Njmf ) { 
            return alert("Please fill all required fields properly"); }
        const tranData = {Nokh: values.Nokh, Name: values.Name, Father: values.Father, Mother: values.Mother, Gfather: values.Gfather, Gmother: values.Gmother, Mstatus: values.Mstatus, Njmf: values.Njmf, };

        if (values.Place) tranData.Place = values.Place;
        if (values.Mobno) tranData.Mobno = Number(values.Mobno);
        
        if (currentDocId) {
            const docRef = doc(tranCol, currentDocId); 
            await updateDoc(docRef, tranData);
            const index = cachedData.findIndex(item => item.id === docRef.id);
            
            if (index !== -1) { cachedData[index] = { ...cachedData[index], ...tranData }; }
            viewAllData();
            document.getElementById("sBtn").textContent = "💾 Save New Name";
        } 
        else {
            const newDocRef = await addDoc(tranCol, tranData); 
            cachedData.push({ id: newDocRef.id, ...tranData });
        }
        clearInput(); 
        currentDocId = null; 
        document.getElementById("Nokh").focus();
    };
    
    window.viewAllData = async function (showDelete = true, showUpdate = true) {
        const allData = await window.fetchAllOnce();
        const rows = [];
        
        allData.forEach((data) => {
            rows.push({
                id: data.id,
                Nokh: data.Nokh,
                Name: data.Name,
                Father: data.Father,
                Mother: data.Mother,
                Gfather: data.Gfather,
                Gmother: data.Gmother,
                Mstatus: data.Mstatus,
                Njmf: data.Njmf,
                Place: data.Place,
                Mobno: data.Mobno,
            });
        });
        const columns = Object.keys(rows[0] || {}).filter(k => k !== "id").map(k => ({ title: k, field: k, headerFilter: "input" })); 
        createEditableTable(rows, columns, showDelete, showUpdate); 
    };

    window.sankhya = async function () {
        const allData = await window.fetchAllOnce();
        const container = document.getElementById("AC");
        container.classList.remove('hidden');
        container.innerHTML = "";

        const groupCounts = {};
        const totalCounts = { Male: 0, Female: 0, UnmarriedNiyani: 0, MarriedNiyani: 0, GaSwaNiyani: 0, Jamai: 0 };

        allData.forEach((data) => {
            if (!data || !data.Nokh) return;
            const group = data.Nokh;
            const Njmf = data.Njmf?.trim();
            const Mstatus = data.Mstatus?.trim();

            if (Mstatus === "Swargiya") return;
            if (!groupCounts[group]) {groupCounts[group] = { Male: 0, Female: 0, UnmarriedNiyani: 0, MarriedNiyani: 0, GaSwaNiyani: 0, Jamai: 0, }; }

            if (Njmf === "Male") { groupCounts[group].Male++; totalCounts.Male++; } 
            else if (Njmf === "Female") { groupCounts[group].Female++; totalCounts.Female++; } 
            else if (Njmf === "Niyani") { if (Mstatus === "Married") { groupCounts[group].MarriedNiyani++; totalCounts.MarriedNiyani++; } 
                else if (Mstatus === "Unmarried") { groupCounts[group].UnmarriedNiyani++; totalCounts.UnmarriedNiyani++; } 
                else if (Mstatus === "gaSwa") { groupCounts[group].GaSwaNiyani++; totalCounts.GaSwaNiyani++;}
            } 
            else if (Njmf === "Jamai") {groupCounts[group].Jamai++; totalCounts.Jamai++;}
        });

        const totalNiyaniAll = totalCounts.MarriedNiyani + totalCounts.UnmarriedNiyani + totalCounts.GaSwaNiyani;
        const grandTotalAll = totalCounts.Male + totalCounts.Female + totalNiyaniAll + totalCounts.Jamai;

        const summaryCard = document.createElement("div");
        summaryCard.style.border = "2px solid #444";
        summaryCard.style.padding = "15px";
        summaryCard.style.borderRadius = "10px";
        summaryCard.style.background = "#f3f4f6";
        summaryCard.style.boxShadow = "3px 3px 10px rgba(0,0,0,0.2)";
        summaryCard.style.lineHeight = "1.4";

        summaryCard.innerHTML = `
            <div><h3 class="text-lg font-bold mb-2 py-2 text-center text-white bg-gradient-to-r from-blue-700 to-green-700 rounded-t-lg shadow">🌟 Total of All Parivars 🌟</h3></div>
            <div style="color: blue;">Unmarried Niyani: ${totalCounts.UnmarriedNiyani}</div>
            <div style="color: blue;">Married Niyani: ${totalCounts.MarriedNiyani}</div>
            <div style="color: blue;">GaSwa Niyani: ${totalCounts.GaSwaNiyani}</div>
            <div style="color: red;">Total Niyani: ${totalNiyaniAll}</div>
            <div style="color: red;">Total Jamai: ${totalCounts.Jamai}</div>
            <div style="color: #064996;">Total Male: ${totalCounts.Male}</div>
            <div style="color: #064996;">Total Female: ${totalCounts.Female}</div>
            <div class="text-black">Grand Total: ${grandTotalAll}</div>
        `;
        container.appendChild(summaryCard);

        for (const [Nokh, counts] of Object.entries(groupCounts)) {
            const totalNiyani = counts.MarriedNiyani + counts.UnmarriedNiyani + counts.GaSwaNiyani;
            const grandTotal = counts.Male + counts.Female + totalNiyani + counts.Jamai;

            const card = document.createElement("div");
            card.style.border = "2px solid #444";
            card.style.padding = "15px";
            card.style.borderRadius = "10px";
            card.style.background = "#f3f4f6";
            card.style.boxShadow = "3px 3px 10px rgba(0,0,0,0.2)";
            card.style.lineHeight = "1.4";

            card.innerHTML = `
                <div><h3 class="text-lg font-bold mb-2 py-2 text-center text-white bg-gradient-to-r from-blue-700 to-green-700 rounded-t-lg shadow">🌟 ${Nokh} Parivar 🌟</h3></div>
                <div style="color: blue;">Unmarried Niyani: ${counts.UnmarriedNiyani}</div>
                <div style="color: blue;">Married Niyani: ${counts.MarriedNiyani}</div>
                <div style="color: blue;">GaSwa Niyani: ${counts.GaSwaNiyani}</div>
                <div style="color: red;">Total Niyani: ${totalNiyani}</div>
                <div style="color: red;">Total Jamai: ${counts.Jamai}</div>
                <div style="color: #064996;">Total Male: ${counts.Male}</div>
                <div style="color: #064996;">Total Female: ${counts.Female}</div>
                <div class="text-black">Grand Total: ${grandTotal}</div>
            `;
            container.appendChild(card);
        }
    };

    window.topStats = async function () {
        const allData = await window.fetchAllOnce();
        const freqNames = {};
        const freqPlaces = {};

        allData.forEach(item => {
            const Name = item.Name?.trim();
            if (Name) freqNames[Name] = (freqNames[Name] || 0) + 1;

            const Place = item.Place?.trim();
            if (Place && Place !== "Vaikunth") freqPlaces[Place] = (freqPlaces[Place] || 0) + 1;
        });

        const sortedNames = Object.entries(freqNames)
            .sort((a, b) => b[1] - a[1])
            .slice(0, 5);

        const sortedPlaces = Object.entries(freqPlaces)
            .sort((a, b) => b[1] - a[1])
            .slice(0, 5);

        const container = document.getElementById('sanCont');
        container.innerHTML = '';

        const placesHeader = document.createElement('h3');
        placesHeader.className ='text-lg font-bold mb-2 text-center text-white p-2 rounded-t-lg shadow-2xl shadow-[0_8px_15px_rgba(0,0,0,0.4)] bg-green-800';
        placesHeader.textContent = '🥇 Top Places With Most People 👨🏻‍👩🏻‍👦🏻‍👦🏻';
        container.appendChild(placesHeader);

        sortedPlaces.forEach(([value, count]) => {
            const label = document.createElement('label');
            label.className = 'block px-2 py-2 mt-1 shadow-2xl shadow-[0_8px_15px_rgba(0,0,0,0.4)] rounded-b-lg';
            label.textContent = `${value} : ${count}`;
            container.appendChild(label);
        });

        const namesHeader = document.createElement('h3');
        namesHeader.className ='text-lg font-bold mb-2 mt-4 text-center text-white p-2 rounded-t-lg shadow-2xl shadow-[0_8px_15px_rgba(0,0,0,0.4)] bg-red-800';
        namesHeader.textContent = '🎖️ Top Names Used In Vigodi 🏅';
        container.appendChild(namesHeader);

        sortedNames.forEach(([value, count]) => {
            const label = document.createElement('label');
            label.className = 'block px-2 py-2 mt-1 shadow-2xl shadow-[0_8px_15px_rgba(0,0,0,0.4)] rounded-b-lg';
            label.textContent = `${value} : ${count}`;
            container.appendChild(label);
        });
        showEle('formCont','bBtn','sanCont',);
    };
    
    window.clearInput = function () { 
        document.querySelectorAll("input").forEach(el => { 
            el.value = ""; 
        }); 
        loadDropdownData();
    };

    window.logout = async function () { 
        if (confirm("Are you sure you want to logout?")) { 
            await signOut(auth); 
            showEle('X','Y','Z'); 
        } 
    };
    
    window.login = async function () {
        const email = document.getElementById("loginEmail").value;
        const password = document.getElementById("loginPassword").value;
        const userCredential = await signInWithEmailAndPassword(auth, email, password);
        const user = userCredential.user;
        const docRef = doc(db, "users", user.uid);
        const docSnap = await getDoc(docRef);
        
        if (docSnap.exists() && docSnap.data().approved === true) { showEle('MC','H1','M1','M2','M3','M4','M5','M6'); }
    };
   
    window.searchAnc = async function () {
        const allFamilyData = await window.fetchAllOnce();
        const Name = document.getElementById("Name").value.trim();
        const Father = document.getElementById("Father").value.trim();
        const Mother = document.getElementById("Mother").value.trim();
        const Gfather = document.getElementById("Gfather").value.trim();
        const Gmother = document.getElementById("Gmother").value.trim();
        const resultsDiv = document.getElementById("AC");
        resultsDiv.classList.remove('hidden');
        resultsDiv.innerHTML = '';

        if (!Name) { return resultsDiv.innerHTML = `<p class='text-red-500 px-2 py-2'>Please enter a name to start the search.</p>`; }

        function findPerson(Name, Father, Mother, Gfather, Gmother) {
            return allFamilyData.find(doc => {
                if (doc.Name !== Name) return false;
                if (Father && doc.Father !== Father) return false;
                if (Mother && doc.Mother !== Mother) return false;
                if (Gfather && doc.Gfather !== Gfather) return false;
                if (Gmother && doc.Gmother !== Gmother) return false;
                return true;
            }) || null;
        }

        async function collectAncestors(person, list = []) {
            if (!person) return list;
            list.push(person);
            const nextPerson = findPerson( person.Father, person.Gfather, person.Gmother, null, null );
            if (nextPerson) { await collectAncestors(nextPerson, list); }
            return list;
        }

        const initialPerson = findPerson( Name, Father, Mother, Gfather, Gmother );
        if (!initialPerson) { return resultsDiv.innerHTML = `<p class='text-red-500 px-2 py-2'>No Ancestors found for provided details.</p>`; }

        const ancestorList = await collectAncestors(initialPerson);
        let outputHtml = '';
        const displayed = new Set();

        ancestorList.forEach(p => {
            if (p.Name && !displayed.has(p.Name)) { outputHtml += `<div class="px-1 bg-pink-500"><span>Name :</span> ${p.Name}</div><div class="border-b border-gray-400"></div>`; displayed.add(p.Name); }
            if (p.Father && !displayed.has(p.Father)) { outputHtml += `<div class="px-1 text-yellow-600"><span>Father :</span> ${p.Father}</div>`; displayed.add(p.Father); }
            if (p.Mother && !displayed.has(p.Mother)) { outputHtml += `<div class="px-1 text-green-500"><span>Mother :</span> ${p.Mother}</div><div class="border-b border-gray-400"></div>`; displayed.add(p.Mother); }
            if (p.Gfather && !displayed.has(p.Gfather)) { outputHtml += `<div class="px-1 text-yellow-600"><span>Grandfather :</span> ${p.Gfather}</div>`; displayed.add(p.Gfather); }
            if (p.Gmother && !displayed.has(p.Gmother)) { outputHtml += `<div class="px-1 text-green-500"><span>Grandmother :</span> ${p.Gmother}</div><div class="border-b border-gray-400"></div>`; displayed.add(p.Gmother); }
        });

        resultsDiv.innerHTML = outputHtml;
    };

    window.addEventListener("beforeunload", function (e) { e.preventDefault(); e.returnValue = ""; });

</script>
</body>
</html>
