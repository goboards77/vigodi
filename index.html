<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Vigodi</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <script src="https://unpkg.com/tabulator-tables@5.5.0/dist/js/tabulator.min.js"></script>    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono&display=swap" rel="stylesheet">
    <link href="https://unpkg.com/tabulator-tables@5.5.0/dist/css/tabulator.min.css" rel="stylesheet">
</head>
<body class="bg-gray-100 p-1" style="font-family: 'Roboto'; font-size: 18px;">
    <div id="menuCont"class="hidden max-w-md p-2 mb-[100px] bg-white rounded-lg shadow-[0_8px_15px_rgba(0,0,0,0.4)]">
        <h2 class="w-full text-center py-3 text-2xl mb-2 text-green-600 shadow-2xl shadow-[0_8px_15px_rgba(0,0,0,0.4)] rounded-b-lg">🤝 Welcome to Vigodi 💐</h2>
        <button class="btnM" onclick="showEle('formCont',11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,'bBtn','sBtn')">✍🏻 Add Name</button>
        <button class="btnM" onclick="showEle('formCont',13,14,15,16,17,18,19,20,21,22,'bBtn','srBtn','sanCont')">👨‍👩‍👦‍👦 Ancestors</button>
        <button class="btnM" onclick="viewAllData(true,true)">👀 All Data</button>
        <button class="btnM" onclick="sankhya()">👀 Sankhya</button>
        <button class="btnM" onclick="topStats()">🏅 Rankings</button>
        <button class="btnM" onclick="logout()">🔐 Logout</button>
    </div>

    <div id="formCont" class="hidden w-full max-w-md grid grid-cols-[auto_1fr] gap-x-2 gap-y-1 p-2 items-center rounded-lg shadow-[0_8px_15px_rgba(0,0,0,0.4)]">
        <button id="bBtn" class="btnM mb-5 text-center bg-lime-400 font-bold" onclick="showEle('menuCont')">🏠︎</button>
        <button id="sBtn" class="btnM text-center mb-5 bg-green-400 font-bold">💾 Save New Name</button>
        <button id="srBtn" class="btnM text-center mb-5 bg-blue-400 font-bold" onclick="startSearch()">🔍 Search</button>   

        <label id="11" class="lbl">Nokh:</label><input id="12" class="inp">
        <label id="13" class="lbl">Name:</label><input id="14" class="inp">
        <label id="15" class="lbl">Father:</label><input id="16" class="inp">
        <label id="17" class="lbl">Mother:</label><input id="18" class="inp">
        <label id="19" class="lbl">GrFather:</label><input id="20" class="inp">
        <label id="21" class="lbl">GrMother:</label><input id="22" class="inp">
        <label id="23" class="lbl">Married:</label><input id="24" class="inp">
        <label id="25" class="lbl">Njmf:</label><input id="26" class="inp">
        <label id="27" class="lbl">Place:</label><input id="28" class="inp">
        <label id="29" class="lbl mb-10">Mob no:</label><input id="30" class="inp mb-10"> 
    </div>

    <div id="sanCont" class="hidden max-w-md p-2 mb-[100px] bg-white rounded-lg shadow-[0_8px_15px_rgba(0,0,0,0.4)]"></div>

    <div id="tblCont" class="hidden w-full p-2 mb-[100px] bg-white rounded-lg shadow-[0_8px_15px_rgba(0,0,0,0.4)]"> 
        <div><input id="searchBox" class="w-full max-w-md px-2 h-10 rounded-lg shadow-[0_8px_15px_rgba(0,0,0,0.8)]" placeholder="Search..." type="text" autocomplete="off"/></div>
        <div class="w-fit flex gap-2 pb-1 pt-2 justify-start">
            <button class="px-5 py-1 bg-purple-500 text-white font-bold rounded-lg duration-500 hover:scale-125" onclick="clearInput(); showEle('menuCont')">🏠︎</button>
            <button id="exlbtn" class="px-4 py-1 bg-green-500 font-bold text-white rounded-lg duration-500 hover:scale-125">XL</button>
            <button id="pdfBtn" class="px-3 py-1 bg-blue-500 font-bold text-white rounded-lg duration-500 hover:scale-125">PDF</button>
        </div>
        <div id="table" class="w-full rounded-lg border border-green-600 mx-auto text-[18px] font-[Roboto]"></div>
    </div>

    <div id="lgnCont" class="hidden w-full max-w-md p-2 rounded-lg shadow-[0_8px_15px_rgba(0,0,0,0.4)]">
        <h2 class="py-3 text-xl">Enter Login Details</h2>
        <label class="block">Email</label><input class="w-full max-w-md py-2 border-b-2 border-green-500" id="loginEmail" type="email" />
        <label class="block mt-3">Password</label><input class="w-full max-w-md py-2 border-b-2 border-green-500" id="loginPassword" type="password" />
        <button class="block mx-auto bg-green-500 text-white px-10 py-3 mt-10 mb-5 rounded-lg shadow-[0_8px_15px_rgba(0,0,0,0.4)]" onclick="login()">🏠︎ Login</button>
    </div>

<script type="module">
    import {initializeApp} 
    from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import {getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut,} 
    from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import {getFirestore, collection, doc, getDocs, getDoc, addDoc, updateDoc, deleteDoc, query, where, deleteField  } 
    from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
    const firebaseConfig = {
        apiKey: "AIzaSyDFYd3RFA0oaJ2A74cLdIm_raus_QHivX8",
        authDomain: "vigodi-64ecd.firebaseapp.com",
        projectId: "vigodi-64ecd",
        storageBucket: "vigodi-64ecd.firebasestorage.app",
        messagingSenderId: "151383854150",
        appId: "1:151383854150:web:ce0bb6c90844203e6f0e47",
        measurementId: "G-4VKY4HEYCG"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    let cachedData = [], currentDocId = null;
    onAuthStateChanged(auth, async (user) => {
        if (user) {
            window.isAdmin = user.email === "goboards77@gmail.com";
            window.tranCol = collection(db, (await getDoc(doc(db, "users", user.uid))).data().db);
            
            await fetchAllOnce(); 
            await loadDropdownData(); 
            showEle('menuCont');

        } else (showEle('lgnCont'))
    });

    function applyClasses(selector, classes, attrs = {}) {
        document.querySelectorAll(selector).forEach(el => {
            if (classes) {el.classList.add(...classes.split(" "));}
            for (const [key, value] of Object.entries(attrs)) {el.setAttribute(key, value);}
        });
    }
    applyClasses(".btnM", "block w-full px-5 py-4 text-left rounded shadow-[0_8px_15px_rgba(0,0,0,0.8)] duration-500 hover:scale-110");
    applyClasses(".lbl", "text-right text-gray-500 font-medium");
    applyClasses(".inp", "bg-gray-100 py-1 border-b-2 border-green-500", { type: "text", autocomplete: "off" });

    window.fetchAllOnce = async function () {
        if (cachedData.length > 0) { return cachedData; }  
        const snapshot = await getDocs(tranCol);
        cachedData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); 
        return cachedData; 
    };

    window.clearInput = function () { document.querySelectorAll("input").forEach(el => { el.value = ""; }); loadDropdownData();};

    window.showEle = function (...ids) {
        Array.from(document.body.children).forEach(el => {el.classList.add("hidden");});
        const container = document.getElementById("formCont");
        Array.from(container.children).forEach(el => {el.classList.add("hidden");});
        ids.forEach(id => { const el = document.getElementById(id); if (el) el.classList.remove("hidden"); });
    };

    window.attachDropdown = function (input, items) {
        const formCont = document.getElementById("formCont");
        formCont.classList.add("relative");
        const list = document.createElement('div');
        list.className = 'absolute z-10 w-full bg-white rounded-b-lg max-h-60 overflow-y-auto hidden border border-gray-500';
        formCont.appendChild(list);

        let filtered = items.slice();
        let index = -1;
        let open = false;

        function render() {
            const rect = input.getBoundingClientRect();
            list.style.width = rect.width + "px";
            list.style.left = input.offsetLeft + "px";
            list.style.top = input.offsetTop + input.offsetHeight + "px";

            list.innerHTML = '';
            if (open && (input.value.trim() !== '' || filtered.length > 0)) {list.classList.remove('hidden');} 
            else {list.classList.add('hidden');}
            filtered.forEach((item, i) => {
                const div = document.createElement('div');
                div.textContent = item;
                div.className = 'px-2 py-1 cursor-pointer hover:bg-blue-700 hover:text-white border-b border-gray-500 last:border-b-0';
                if (i === index) div.classList.add('bg-blue-500', 'text-white');
                div.addEventListener('mousedown', e => e.preventDefault());
                div.addEventListener('click', () => select(item));
                list.appendChild(div);
            });
        }

        function select(value) {
            input.value = value;
            list.classList.add('hidden');
            const allInputs = Array.from(document.querySelectorAll('#formCont input:not([type="hidden"])'));
            const currentIndex = allInputs.indexOf(input);
            if (currentIndex !== -1 && allInputs[currentIndex + 1]) {
                allInputs[currentIndex + 1].focus();
            }
        }

        input.addEventListener('focus', () => { open = true; render(); });
        input.addEventListener('blur', () => { setTimeout(() => { open = false; render(); }, 150); });
        input.addEventListener('input', () => {
            const q = input.value.toLowerCase();
            filtered = items.filter(i => i.toLowerCase().includes(q));
            index = -1;
            render();
        });
        input.addEventListener('keydown', e => {
            if (e.key === 'ArrowDown') { e.preventDefault(); index = Math.min(index + 1, filtered.length - 1); render(); }
            else if (e.key === 'ArrowUp') { e.preventDefault(); index = Math.max(index - 1, 0); render(); }
            else if (e.key === 'Enter') { e.preventDefault(); if (index >= 0) select(filtered[index]); }
            else if (e.key === 'Escape') list.classList.add('hidden');
        });
    }

    window.loadDropdownData = async function () {
        const nokhSet = new Set();
        const nameSet = new Set();
        const placeSet = new Set();
        cachedData.forEach(d => {
            if (d.nokh?.trim()) nokhSet.add(d.nokh.trim());
            if (d.name?.trim()) nameSet.add(d.name.trim());
            if (d.fName?.trim()) nameSet.add(d.fName.trim());
            if (d.place?.trim()) placeSet.add(d.place.trim());
        });
        const dropdownData = {
            '12': [...nokhSet].sort(),
            '14': [...nameSet].sort(),
            '16': [...nameSet].sort(),
            '18': [...nameSet].sort(),
            '20': [...nameSet].sort(),
            '22': [...nameSet].sort(),
            '24': ['Married', 'Unmarried', 'Vidhur', 'Gaswa', 'Swargiya'],
            '26': ["Niyani", "Jamai", "Male", "Female"],
            '28': [...placeSet].sort(),
            '30': [],
        };

        Object.keys(dropdownData).forEach(id => {
            const input = document.getElementById(id);
            if (input) {attachDropdown(input, dropdownData[id]);}
            if (input.type === "text") {
            input.addEventListener('input', function () {
                const start = this.selectionStart;
                const end = this.selectionEnd;
                this.value = this.value.toLowerCase().replace(/\b\w/g, char => char.toUpperCase());
                this.setSelectionRange(start, end);
            });
        }
        });
    };

    window.createEditableTable = function (rows, columns, showDelete = true, showUpdate = true, editable = false) {
        if (window.table && typeof window.table.destroy === "function") window.table.destroy();
        const isMobile = window.innerWidth < 768;  
        const searchId = document.getElementById('searchBox');

        let fullColumns = columns.map(col => {
            if (isMobile && col.field === "id") return { ...col, visible: false };
            return { ...col, editor: editable ? col.editor || "input" : false };
        });

        if (!isMobile) {
            if (isAdmin && showDelete) {
                fullColumns.push({
                    title: "",
                    field: "__delete",
                    formatter: () => `<div class="text-center cursor-pointer">⛔</div>`,
                    width: 70,
                    hozAlign: "center",
                    cellClick: async (e, cell) => {
                        e.stopPropagation();
                        const rowData = cell.getRow().getData();
                        const confirmed = confirm("Delete? Are You Sure?");
                        if (confirmed && rowData.id) {
                            await deleteDoc(doc(tranCol, rowData.id));
                            cell.getRow().delete();
                            if (cachedData) cachedData = cachedData.filter(doc => doc.id !== rowData.id);
                        }
                    },
                });
            }

            if (isAdmin && showUpdate) {
                fullColumns.push({
                    title: "",
                    field: "__update",
                    formatter: () => `<div class="text-center cursor-pointer">✏️</div>`,
                    width: 70,
                    hozAlign: "center",
                    cellClick: (e, cell) => {
                        e.stopPropagation();
                        const rowData = cell.getRow().getData();
                        currentDocId = rowData.id;
                        showTransactionContainer(rowData);
                    },
                });
            }
        }

        window.table = new Tabulator(document.getElementById('table'), {
            data: rows,
            layout: "fitDataFill",
            reactiveData: true,
            rowHeight: 40,
            maxHeight: "675px",
            headerVisible: !isMobile,
            columns: fullColumns,
            rowFormatter: isMobile ? function (row) {
                row.getElement().style.display = "block";
                let d = row.getData();
                let card = document.createElement("div");
                card.className = `w-full max-w-md bg-white grid grid-cols-[100px_1fr] mb-1 text-[18px] font-[Roboto] rounded-lg border border-green-500`;

                let inner = "";
                columns.forEach(col => {
                    if (col.field !== "__delete" && col.field !== "__update") {
                        const val = d[col.field];
                        if (val !== undefined && val !== null && val !== "") { 
                            inner += ` <div class="text-gray-700 text-right px-1">${col.title}:</div> <div class="text-black px-1">${val}</div> `; 
                        }
                    }
                });

                if (isAdmin && (showDelete || showUpdate)) {
                    inner += `<div class="col-span-2 pb-2 pr-5 flex justify-end gap-20 rounded-lg">`;
                    if (showDelete) inner += `<span class="delete-btn cursor-pointer">⛔</span>`;
                    if (showUpdate) inner += `<span class="update-btn cursor-pointer">✏️</span>`;
                    inner += `</div>`;
                }

                card.innerHTML = inner;
                row.getElement().innerHTML = "";
                row.getElement().appendChild(card);

                if (isAdmin && showDelete) {
                    card.querySelector(".delete-btn")?.addEventListener("click", async (e) => {
                        e.stopPropagation();
                        const confirmed = confirm("Delete? Are You Sure?");
                        if (confirmed && d.id) {
                            await deleteDoc(doc(tranCol, d.id));
                            row.delete();
                            if (cachedData) cachedData = cachedData.filter(doc => doc.id !== d.id);
                        }
                    });
                }

                if (isAdmin && showUpdate) {
                    card.querySelector(".update-btn")?.addEventListener("click", (e) => {
                        e.stopPropagation();
                        currentDocId = d.id;
                        showTransactionContainer(d);
                    });
                }
            } : undefined
        });
        table.on("headerDblClick", function(e, column){ let field = column.getField();  table.deleteColumn(field); });
        document.getElementById('exlbtn')?.addEventListener("click", () => { window.table.download("xlsx", "data.xlsx", { sheetName: "Sheet1" }); });
        document.getElementById('pdfBtn')?.addEventListener("click", () => { window.table.download("pdf", "data.pdf", { orientation: "portrait" }); });
        document.getElementById('prtBtn')?.addEventListener("click", () => { window.table.print(false, true); });
        bindSearch(); 
        showEle("tblCont");
    };    

    window.bindSearch = function () {
        document.getElementById("searchBox").addEventListener("input", function () {
            const value = this.value.toLowerCase().trim();
            table.setFilter(function (data) {
                if (value === "") { return true; }
                return Object.values(data).some(val => String(val).toLowerCase().includes(value)); 
            }); 
        }); 
    };
   
    window.showTransactionContainer = function (rowData) {
        clearInput(); 
        showEle('eleCont');
        for (const key in rowData) {
            if (rowData.hasOwnProperty(key)) {
                const input = document.getElementById(key); 
                if (input) {input.value = rowData[key] || "";} 
            } 
        }
    };

    window.saveTransaction = async function () {
        const nokh = document.getElementById("12").value.trim();
        const name = document.getElementById("14").value.trim();
        const fName = document.getElementById("16").value.trim();
        const mName = document.getElementById("18").value.trim();
        const gfName = document.getElementById("20").value.trim();
        const gmName = document.getElementById("22").value.trim();
        const mStatus = document.getElementById("24").value.trim();
        const njmf = document.getElementById("26").value.trim();
        const mob = document.getElementById("28").value;
        const place = document.getElementById("30").value.trim();
        
        if (!nokh || !name || !fName || !mName || !gfName || !gmName || !mStatus || !njmf ) { 
            return alert("Please fill all required fields properly"); 
        }

        const tranData = {nokh, name, fName, mName, gfName, gmName, mStatus, njmf, };

        if (mob) tranData.mob = Number(mob);
        if (place) tranData.place = place;
        if (mStatus === "Swargiya") tranData.place = "Vaikunth";
        
        if (currentDocId) {
            const docRef = doc(tranCol, currentDocId); 
            await updateDoc(docRef, tranData);
            const index = cachedData.findIndex(item => item.id === docRef.id);
            
            if (index !== -1) { cachedData[index] = { ...cachedData[index], ...tranData }; }
            viewAllData();
        } 
        else {
            const newDocRef = await addDoc(tranCol, tranData); 
            cachedData.push({ id: newDocRef.id, ...tranData });
        }
        clearInput(); 
        currentDocId = null; 
        //document.activeElement.blur();
        document.getElementById("nokh").focus();
    };
    
    window.findSpecificDocument = function (name, fName, mName, gfName, gmName, data) {
        if (!data || data.length === 0) {return null; }
        const result = data.find(doc => {
            if (doc.name !== name) { return false;}
            if (fName && doc.fName !== fName) {return false;}
            if (mName && doc.mName !== mName) {return false;}
            if (gfName && doc.gfName !== gfName) {return false;}
            if (gmName && doc.gmName !== gmName) {return false;}
            return true;
        });
        return result || null;
    };

    window.collectAncestorData = async function (personData, data, ancestorList = []) {
        if (!personData) { return ancestorList; }
        ancestorList.push(personData);
        const fNameOfCurrent = personData.fName;
        const gfNameOfCurrent = personData.gfName;
        const gmNameOfCurrent = personData.gmName;
        const nextPersonData = findSpecificDocument(fNameOfCurrent, gfNameOfCurrent, gmNameOfCurrent, null, null, data);
        
        if (nextPersonData) {
            await collectAncestorData(nextPersonData, data, ancestorList);
        }
        return ancestorList;
    };
    
    window.findAndDisplayAncestors = async function (startData) {
        const resultsDiv = document.getElementById("sanCont");
        resultsDiv.innerHTML = '';
        if (!startData || !startData.name) {
            resultsDiv.innerHTML += `<p>Please enter a name to start the search.</p>`; 
            return;
        }
        const allFamilyData = await window.fetchAllOnce();
        const initialPersonData = findSpecificDocument(startData.name, startData.fName, startData.mName, startData.gfName, startData.gmName, allFamilyData );
        if (!initialPersonData) {
            resultsDiv.innerHTML += `<p>No person matching the provided details was found.</p>`; 
            return; 
        }
        const ancestorList = await collectAncestorData(initialPersonData, allFamilyData);
        let outputHtml = '';
        const displayedNames = new Set();

        ancestorList.forEach((personData) => {
            const name = personData.name;
            const fName = personData.fName;
            const mName = personData.mName;
            const gfName = personData.gfName;
            const gmName = personData.gmName;

            if (name && !displayedNames.has(name)) {
                outputHtml += `<div class="px-1 py-1"><span>Name :</span> ${name}</div><div class="border-b border-gray-400"></div>`; 
                displayedNames.add(name);
            }
            if (fName && !displayedNames.has(fName)) {
                outputHtml += `<div class="px-1 py-1 text-yellow-600"><span>Father :</span> ${fName}</div>`; 
                displayedNames.add(fName);
            }
            if (mName && !displayedNames.has(mName)) {
                outputHtml += `<div class="px-1 py-1 text-green-500"><span>Mother :</span> ${mName}</div><div class="border-b border-gray-400"></div>`; 
                displayedNames.add(mName); }
            if (gfName && !displayedNames.has(gfName)) {
                outputHtml += `<div class="px-1 py-1 text-yellow-600"><span>Grandfather :</span> ${gfName}</div>`; displayedNames.add(gfName);
            }
            if (gmName && !displayedNames.has(gmName)) {
                outputHtml += `<div class="px-1 py-1 text-green-500"><span>Grandmother :</span> ${gmName}</div><div class="border-b border-gray-400"></div>`; 
                displayedNames.add(gmName);
            }
        });
        resultsDiv.innerHTML = `${outputHtml}`;
    };

    window.startSearch = function () {
        const startData = { 
            name: document.getElementById("14").value.trim(),
            fName: document.getElementById("16").value.trim(), 
            mName: document.getElementById("18").value.trim(), 
            gfName: document.getElementById("20").value.trim(), 
            gmName: document.getElementById("22").value.trim(),
        };
        window.findAndDisplayAncestors(startData);
    };
    
    window.viewAllData = async function (showDelete = true, showUpdate = true) {
        const allData = await window.fetchAllOnce();
        const rows = [];
        
        allData.forEach((data) => {
            rows.push({
                id: data.id,
                nokh: data.nokh,
                name: data.name,
                fName: data.fName,
                mName: data.mName,
                gfName: data.gfName,
                gmName: data.gmName,
                mStatus: data.mStatus,
                njmf: data.njmf,
                place: data.place,
                mob: data.mob,
            });
        });

        const columns = [
            {title: "Parivar", field: "nokh"}, 
            {title: "Name", field: "name"}, 
            {title: "Father", field: "fName"}, 
            {title: "Mother", field: "mName"}, 
            {title: "GrFather", field: "gfName"}, 
            {title: "GrMother", field: "gmName"},
            {title: "MStatus", field: "mStatus"}, 
            {title: "NJMF", field: "njmf"},
            {title: "Place", field: "place"},
            {title: "Mob No", field: "mob"},
        ];
        createEditableTable(rows, columns, showDelete, showUpdate); 
    };

    window.sankhya = async function () {
        const allData = await window.fetchAllOnce();
        const container = document.getElementById("sanCont");
        container.innerHTML = "";

        const groupCounts = {};
        const totalCounts = { 
            Male: 0, 
            Female: 0, 
            UnmarriedNiyani: 0, 
            MarriedNiyani: 0, 
            GaSwaNiyani: 0, 
            Jamai: 0 
        };

        allData.forEach((data) => {
            if (!data || !data.nokh) return;
            const group = data.nokh;
            const njmf = data.njmf?.trim();
            const mStatus = data.mStatus?.trim();

            if (mStatus === "Swargiya") return;

            if (!groupCounts[group]) {
                groupCounts[group] = { 
                    Male: 0, 
                    Female: 0, 
                    UnmarriedNiyani: 0,
                    MarriedNiyani: 0,  
                    GaSwaNiyani: 0, 
                    Jamai: 0, 
                };
            }

            if (njmf === "Male") {
                groupCounts[group].Male++;
                totalCounts.Male++;
            } 
            else if (njmf === "Female") {
                groupCounts[group].Female++;
                totalCounts.Female++;
            } 
            else if (njmf === "Niyani") {
                if (mStatus === "Married") {
                    groupCounts[group].MarriedNiyani++;
                    totalCounts.MarriedNiyani++;
                } 
                else if (mStatus === "Unmarried") {
                    groupCounts[group].UnmarriedNiyani++;
                    totalCounts.UnmarriedNiyani++;
                } 
                else if (mStatus === "gaSwa") {
                    groupCounts[group].GaSwaNiyani++;
                    totalCounts.GaSwaNiyani++;
                }
            } 
            else if (njmf === "Jamai") {
                groupCounts[group].Jamai++;
                totalCounts.Jamai++;
            }
        });

        const totalNiyaniAll = totalCounts.MarriedNiyani + totalCounts.UnmarriedNiyani + totalCounts.GaSwaNiyani;
        const grandTotalAll = totalCounts.Male + totalCounts.Female + totalNiyaniAll + totalCounts.Jamai;

        const summaryCard = document.createElement("div");
        summaryCard.style.border = "2px solid #444";
        summaryCard.style.padding = "15px";
        summaryCard.style.borderRadius = "10px";
        summaryCard.style.background = "#f3f4f6";
        summaryCard.style.boxShadow = "3px 3px 10px rgba(0,0,0,0.2)";
        summaryCard.style.lineHeight = "1.4";

        summaryCard.innerHTML = `
            <div><h3 class="text-lg font-bold mb-2 py-2 text-center text-white bg-gradient-to-r from-blue-700 to-green-700 rounded-t-lg shadow">🌟 Total of All Parivars 🌟</h3></div>
            <div style="color: blue;">Unmarried Niyani: ${totalCounts.UnmarriedNiyani}</div>
            <div style="color: blue;">Married Niyani: ${totalCounts.MarriedNiyani}</div>
            <div style="color: blue;">GaSwa Niyani: ${totalCounts.GaSwaNiyani}</div>
            <div style="color: red;">Total Niyani: ${totalNiyaniAll}</div>
            <div style="color: red;">Total Jamai: ${totalCounts.Jamai}</div>
            <div style="color: #064996;">Total Male: ${totalCounts.Male}</div>
            <div style="color: #064996;">Total Female: ${totalCounts.Female}</div>
            <div class="text-black">Grand Total: ${grandTotalAll}</div>
        `;
        container.appendChild(summaryCard);

        for (const [nokh, counts] of Object.entries(groupCounts)) {
            const totalNiyani = counts.MarriedNiyani + counts.UnmarriedNiyani + counts.GaSwaNiyani;
            const grandTotal = counts.Male + counts.Female + totalNiyani + counts.Jamai;

            const card = document.createElement("div");
            card.style.border = "2px solid #444";
            card.style.padding = "15px";
            card.style.borderRadius = "10px";
            card.style.background = "#f3f4f6";
            card.style.boxShadow = "3px 3px 10px rgba(0,0,0,0.2)";
            card.style.lineHeight = "1.4";

            card.innerHTML = `
                <div><h3 class="text-lg font-bold mb-2 py-2 text-center text-white bg-gradient-to-r from-blue-700 to-green-700 rounded-t-lg shadow">🌟 ${nokh} Parivar 🌟</h3></div>
                <div style="color: blue;">Unmarried Niyani: ${counts.UnmarriedNiyani}</div>
                <div style="color: blue;">Married Niyani: ${counts.MarriedNiyani}</div>
                <div style="color: blue;">GaSwa Niyani: ${counts.GaSwaNiyani}</div>
                <div style="color: red;">Total Niyani: ${totalNiyani}</div>
                <div style="color: red;">Total Jamai: ${counts.Jamai}</div>
                <div style="color: #064996;">Total Male: ${counts.Male}</div>
                <div style="color: #064996;">Total Female: ${counts.Female}</div>
                <div class="text-black">Grand Total: ${grandTotal}</div>
            `;
            container.appendChild(card);
        }
        showEle('formCont','bBtn','sanCont',);
    };

    window.topStats = async function () {
        const allData = await window.fetchAllOnce();
        const freqNames = {};
        const freqPlaces = {};

        allData.forEach(item => {
            const name = item.name?.trim();
            if (name) freqNames[name] = (freqNames[name] || 0) + 1;

            const place = item.place?.trim();
            if (place && place !== "Vaikunth") freqPlaces[place] = (freqPlaces[place] || 0) + 1;
        });

        const sortedNames = Object.entries(freqNames)
            .sort((a, b) => b[1] - a[1])
            .slice(0, 5);

        const sortedPlaces = Object.entries(freqPlaces)
            .sort((a, b) => b[1] - a[1])
            .slice(0, 5);

        const container = document.getElementById('sanCont');
        container.innerHTML = '';

        const placesHeader = document.createElement('h3');
        placesHeader.className ='text-lg font-bold mb-2 text-center text-white p-2 rounded-t-lg shadow-2xl shadow-[0_8px_15px_rgba(0,0,0,0.4)] bg-green-800';
        placesHeader.textContent = '🥇 Top Places With Most People 👨🏻‍👩🏻‍👦🏻‍👦🏻';
        container.appendChild(placesHeader);

        sortedPlaces.forEach(([value, count]) => {
            const label = document.createElement('label');
            label.className = 'block px-2 py-2 mt-1 shadow-2xl shadow-[0_8px_15px_rgba(0,0,0,0.4)] rounded-b-lg';
            label.textContent = `${value} : ${count}`;
            container.appendChild(label);
        });

        const namesHeader = document.createElement('h3');
        namesHeader.className ='text-lg font-bold mb-2 mt-4 text-center text-white p-2 rounded-t-lg shadow-2xl shadow-[0_8px_15px_rgba(0,0,0,0.4)] bg-red-800';
        namesHeader.textContent = '🎖️ Top Names Used In Vigodi 🏅';
        container.appendChild(namesHeader);

        sortedNames.forEach(([value, count]) => {
            const label = document.createElement('label');
            label.className = 'block px-2 py-2 mt-1 shadow-2xl shadow-[0_8px_15px_rgba(0,0,0,0.4)] rounded-b-lg';
            label.textContent = `${value} : ${count}`;
            container.appendChild(label);
        });
        showEle('formCont','bBtn','sanCont',);
    };
    
    window.logout = async function () { showEle(); if (confirm("Are you sure you want to logout?")) { await signOut(auth); showEle("lgnCont"); } };
    
    window.login = async function () {
        const email = document.getElementById("loginEmail").value;
        const password = document.getElementById("loginPassword").value;
        const userCredential = await signInWithEmailAndPassword(auth, email, password);
        const user = userCredential.user;
        const docRef = doc(db, "users", user.uid);
        const docSnap = await getDoc(docRef);
        
        if (docSnap.exists() && docSnap.data().approved === true) { showEle("menuCont"); }
    };
   
    window.addEventListener("beforeunload", function (e) { e.preventDefault(); e.returnValue = ""; });
    
</script>
</body>
</html>
